<div class="cart">
<h1>Shopping Cart</h1>

  <% if (sessionCart) { %>
        <% sessionCart.forEach(item => { %>
            <div class="author-row">
              <div><%= item.name %></div>
              <div><%= item.size %></div>
              <div><%= item.quantity %></div>
              <div><%= item.price %></div>
              <div><%= item.total %></div>
        
              <div class="btn-row">
                <form action="/checkout/cart/<%= item.product %>/remove" method="post">
                  <button type="submit">Remove</button>
                </form>
              </div>
            </div>
          <% }) %>
        
          <p>Total Items: <%= sessionCart.reduce((total, item) => total + Number(item.quantity), 0) %></p>
          <p>Subtotal: <%= sessionCart.reduce((total, item) => total + Number(item.subtotal), 0) %></p>
          <p>Total Price: <%= totalPrice %></p>
      <a href="/checkout/shipping" class="women btn btn-primary">checkout</a><br>


<% } else if (cart) { %>
  <% if(cart.total_items > 0) { %>
  <table class="table">
    <thead class="thead-light">
      <tr>
        <th scope="col">○</th>
        <th scope="col">Product</th>
        <th scope="col">Size</th>
        <th scope="col">Quantity</th>
        <th scope="col">Price</th>
        <th scope="col">Total*</th>
      </tr>
    </thead>
    <tbody>
      <% cart.items.forEach(item => { %>

        
        <tr data-item-id="<%= item.id %>">
          <th scope="row">○</th>

          <td>
            <a href="/men/<%= item.product.id %>">
            <img src="<%= item.product.coverImagePath1 %>" alt="<%= item.product.name %> Image" width="100" height="100">
            <%= item.product.name %>
          </a>
          </td>
          <td><%= item.size %></td>
          <td>
            <form action="/checkout/count" method="post">

              <% if(item.quantity > 1) { %>

                <button type="button" onclick="updateQuantity('<%= item.id %>', 'decrement')">&larr;</button>

              <% } else { %>

                <button type="button" name="action" value="decrement" disabled>&larr;</button>

                <% } %>

              <%= item.quantity %>
              <button type="button" onclick="updateQuantity('<%= item.id %>', 'increment')">&rarr;</button>
              <input type="hidden" name="itemId" value="<%= item.id %>">
            </form>
          </td>
          <td>$<%= item.product.price %></td>
          <td>$<%= item.subtotal %></td>
          <td>
            <%- include('removeForm', { url: `/checkout/cart/${item.id}/remove`}) %>
          </td>
        </tr>


      <% }) %>
      
    </tbody>
    </table>
    
<div class="checkout-details">

  <div>
  <p>Total Items: <%= cart.total_items %></p>
  <p>Subtotal: $<%= cart.subtotal %> **</p>
  <div class="underline"></div>
  <p>Total Price: $<%= cart.total %></p>
</div>

<div class="cForm">
  <p type="button" style="margin-right: 0.5rem;" data-toggle="tooltip" data-placement="left" title='If you would like to redeem your Gift Card/promotion code on this order, please enter the code in the designated field and click "use code"'>
    <i class="bi bi-exclamation-circle text-secondary"></i>
  </p>
  <form action="">
    
  <input type="text" id="coupon" name="coupon" placeholder="Gift Card / Coupon / Promo Code" style="width: 20rem;">
  <input class="bttn bttn-info" type="submit" value="USE CODE">
</form>
</div>

</div>

<a href="/checkout/shipping" class="text-center d-flex align-items-center justify-content-center bttn bttn-pri">proceed to checkout</a><br>
<br>
<br>
<p class="text-secondary"><small>* product price before 10% VAT</small></p>
<p class="text-secondary"><small>** total cart items price before 10% VAT</small></p>
<% } else { %>
  <p>Your cart is empty.</p>
  <% } %>
<% } else { %>
  <p>Your cart is empty.</p>
<% } %>
</div>

<style>

  .checkout-details {
    display: flex;
    justify-content: space-between;
  }
  .cForm {
    display: flex;
  
    margin-right: 2rem;
    width: 32rem;

  }

  .underline{
    width: 10rem;
    border: 0.5px solid rgb(214, 214, 214);
    margin-bottom: 0.5rem;
  }
  /* Add some spacing between the table cells */
  table {
    border-collapse: separate;
    border-spacing: 10px;
    width: 100%; /* Set the table width to 80% */
    margin: auto; /* Center the table within its container */
  }

  /* Style for table headers and cells */
  th, td {
    padding: 10px;
    text-align: left; /* Align text to the left */
  }

  /* Style for table headers */
  th {
    font-weight: bold;
  }

</style>



<script>
  // Function to update item quantity using AJAX
  function updateQuantity(itemId, action) {
    // Create a JSON object with the action and itemId
    const data = {
      action: action,
      itemId: itemId
    };

    // Send a POST request to your server
    fetch('/checkout/count', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json()) // Parse the JSON response
    .then(updatedCart => {
      console.log(updatedCart); // Log the updated cart data
      updateCartUI(updatedCart);
      })
      .catch(error => {
        console.error('Error updating quantity:', error);
      });
  }

  // Function to update the cart UI with new data
  function updateCartUI(cartData) {
    // Update the cart table, total items, subtotal, and total price on the page
    // You'll need to write code here to update your HTML elements
  }



  // Function to update the cart UI with new data
function updateCartUI(cartData) {
  // Update the cart table, total items, subtotal, and total price on the page
  const cartTable = document.getElementById('cart-table');
  const totalItems = document.getElementById('total-items');
  const subtotal = document.getElementById('subtotal');
  const totalPrice = document.getElementById('total-price');

  // Update the cart table
  cartTable.innerHTML = ''; // Clear existing table rows
  cartData.items.forEach((item) => {
    // Create and append rows to the table based on cartData
    const row = document.createElement('tr');
    // Build the row content based on item data
    // Example:
    row.innerHTML = `<td>${item.product.name}</td><td>${item.size}</td><td>${item.quantity}</td><td>${item.product.price}</td><td>${item.subtotal}</td>`;
    cartTable.appendChild(row);
  });

  // Update total items, subtotal, and total price
  totalItems.textContent = cartData.total_items;
  subtotal.textContent = cartData.subtotal;
  totalPrice.textContent = cartData.total;
}


</script>


